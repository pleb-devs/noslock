// Capture the native WebSocket implementation before importing polyfill (if it exists)
const OriginalWebSocket = globalThis.WebSocket;
import "websocket-polyfill";
const PolyfilledWebSocket = globalThis.WebSocket;
function hasRequiredWebSocketFeatures(wsCtor) {
    if (!wsCtor || !wsCtor.prototype) {
        return false;
    }
    const proto = wsCtor.prototype;
    const binaryTypeDescriptor = Object.getOwnPropertyDescriptor(proto, "binaryType");
    const hasSend = typeof proto.send === "function";
    const hasClose = typeof proto.close === "function";
    const hasBinaryTypeSetter = typeof binaryTypeDescriptor?.set === "function";
    return hasSend && hasClose && hasBinaryTypeSetter;
}
function resolveDefaultWebSocket() {
    const currentGlobal = globalThis.WebSocket;
    const candidatesWithPriority = [];
    if (currentGlobal &&
        currentGlobal !== OriginalWebSocket &&
        currentGlobal !== PolyfilledWebSocket) {
        candidatesWithPriority.push(currentGlobal);
    }
    candidatesWithPriority.push(OriginalWebSocket, PolyfilledWebSocket);
    for (const candidate of candidatesWithPriority) {
        if (hasRequiredWebSocketFeatures(candidate)) {
            return candidate;
        }
    }
    const fallbackCandidates = [
        OriginalWebSocket,
        currentGlobal,
        PolyfilledWebSocket,
    ];
    for (const candidate of fallbackCandidates) {
        if (candidate) {
            return candidate;
        }
    }
    return undefined;
}
let WebSocketImpl = resolveDefaultWebSocket();
export function useWebSocketImplementation(wsCtor) {
    WebSocketImpl = wsCtor;
}
export function resetWebSocketImplementation() {
    WebSocketImpl = resolveDefaultWebSocket();
}
export function getWebSocketImplementation() {
    if (!WebSocketImpl) {
        throw new Error("WebSocket implementation not available. Make sure websocket-polyfill is properly loaded.");
    }
    return WebSocketImpl;
}
